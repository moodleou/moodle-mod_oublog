define("mod_oublog/main",["exports","core/str","mod_oublog/modal","core/modal_events","core/local/aria/focuslock","core/pending","tiny_autosave/repository"],(function(_exports,_str,_modal,ModalEvents,FocusLock,_pending,TinyRepository){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}
/**
   * Main js on mod_oublog plugin.
   *
   * @module      mod_oublog/main
   * @copyright   2024 The Open University
   * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
   */Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.initShowHide=_exports.initPostTable=_exports.initDeleteAndEmail=_exports.init=void 0,_modal=_interopRequireDefault(_modal),ModalEvents=_interopRequireWildcard(ModalEvents),FocusLock=_interopRequireWildcard(FocusLock),_pending=_interopRequireDefault(_pending),TinyRepository=_interopRequireWildcard(TinyRepository);const hideWarning=()=>{const pendingPromise=new _pending.default("mod/oublog:hideWarning"),field=document.querySelector("#publicwarningmarker"),select=document.querySelector("#id_allowcomments");if(field&&select){field.parentNode.parentNode.style.setProperty("display",2==select.value?"block":"none","important")}pendingPromise.resolve()};_exports.init=()=>{hideWarning(),initButtons();const comments=document.querySelector("#id_allowcomments");comments&&comments.addEventListener("change",hideWarning)};_exports.initShowHide=(name,curPref)=>{const block=document.querySelector(".oublog_statsview_content_".concat(name));if(block){const showHide=block.querySelector(".block_action_oublog"),form=block.querySelector("form.mform");if(showHide&&form){const hideInfo=block.querySelector(".oublog_stats_minus"),showInfo=block.querySelector(".oublog_stats_plus");1===curPref&&(form.classList.add("oublog_displaynone"),hideInfo.classList.add("oublog_displaynone"),showInfo.classList.remove("oublog_displaynone"));const elements={hideInfo:hideInfo,showInfo:showInfo,form:form};showHide.addEventListener("click",(e=>{curPref=toggleVisibility(e,elements,curPref,name)})),showHide.addEventListener("keypress",(e=>{"Enter"===e.key&&(curPref=toggleVisibility(e,elements,curPref,name))}))}}};const toggleVisibility=(e,elements,curPref,name)=>{const pendingPromise=new _pending.default("mod/oublog:toggleVisibility");e.preventDefault();const{hideInfo:hideInfo,showInfo:showInfo,form:form}=elements;return 1===curPref?(hideInfo.classList.remove("oublog_displaynone"),showInfo.classList.add("oublog_displaynone"),form.classList.remove("oublog_displaynone"),curPref=0):(hideInfo.classList.add("oublog_displaynone"),showInfo.classList.remove("oublog_displaynone"),form.classList.add("oublog_displaynone"),curPref=1),document.body.classList.contains("notloggedin")||require(["core_user/repository"],(userRepository=>{userRepository.setUserPreference("mod_oublog_hidestatsform_".concat(name),curPref)})),pendingPromise.resolve(),curPref};_exports.initDeleteAndEmail=(cmId,postId)=>{const deleteBtn=document.querySelector("a.oublog_deleteandemail_".concat(postId));deleteBtn&&deleteBtn.addEventListener("click",(async e=>{e.preventDefault();const pendingPromise=new _pending.default("core/notification:confirm");let uri=deleteBtn.href;const content=await(0,_str.getString)("deleteemailpostdescription","oublog"),modal=await _modal.default.create({templateContext:{content:content}}),$root=await modal.getRoot();FocusLock.trapFocus(document.querySelector(".modal-dialog.oublog-delete-modal")),$root.on(ModalEvents.hidden,(function(){modal.destroy(),FocusLock.untrapFocus()})),$root.on(ModalEvents.delete,(e=>{e.preventDefault(),uri+="&confirm=1",document.location.href=uri})),$root[0].addEventListener("click",(e=>{e.target.closest('[data-action="deleteandmail"]')&&(e.preventDefault(),uri+="&email=1",document.location.href=uri,modal.hide(),modal.destroy())})),pendingPromise.resolve()}))};const updatePreselect=(check,preSelectInput)=>{const pendingPromise=new _pending.default("mod/oublog:updatePreselect");let preSelect=preSelectInput.value;const id=check.name.substring(5);if(check.checked){if(id){const preArray=preSelect?preSelect.split(","):[];preArray.includes(id)||(preArray.push(id),preSelectInput.value=preArray.join(","),updateLinks(preArray))}}else if(preSelect&&id){const preArray=preSelect.split(","),index=preArray.indexOf(id);-1!==index&&(preArray.splice(index,1),preSelectInput.value=preArray.join(","),updateLinks(preArray))}pendingPromise.resolve()},updateLinks=preArray=>{const pendingPromise=new _pending.default("mod/oublog:updateLinks");document.querySelectorAll(".oublog_import_step1 form .paging a, .flexible a").forEach((link=>{const url=new URL(link.href);url.searchParams.set("preselected",preArray.join(",")),link.href=url.toString()})),pendingPromise.resolve()};_exports.initPostTable=async()=>{const includeHead=document.querySelector(".flexible .header.c3"),postChecks=document.querySelectorAll('.flexible td.c3 input[type="checkbox"]'),preSelectInput=document.querySelector("form input[name=preselected]");if(includeHead&&postChecks){const[selectAll,none]=await(0,_str.getStrings)(["import_step1_all","import_step1_none"].map((key=>({key:key,component:"oublog"}))));includeHead.innerHTML+='\n            <a href="#" class="oublog_import_all">'.concat(selectAll,'</a> /\n            <a href="#" class="oublog_import_none">').concat(none,"</a>\n        "),document.querySelector(".flexible .c3 .oublog_import_all").addEventListener("click",(e=>{e.preventDefault(),postChecks.forEach((check=>{check.checked=!0,updatePreselect(check,preSelectInput)}))})),document.querySelector(".flexible .c3 .oublog_import_none").addEventListener("click",(e=>{e.preventDefault(),postChecks.forEach((check=>{check.checked=!1,updatePreselect(check,preSelectInput)}))}))}postChecks&&preSelectInput&&postChecks.forEach((check=>{check.addEventListener("click",(()=>{updatePreselect(check,preSelectInput)}))}))};const initButtons=()=>{const submitButton=document.getElementById("id_submitbutton");submitButton&&submitButton.addEventListener("click",(()=>{var _window$tinyMCE;const editor=null===(_window$tinyMCE=window.tinyMCE)||void 0===_window$tinyMCE?void 0:_window$tinyMCE.get("id_message");editor&&TinyRepository.removeAutosaveSession(editor)}))}}));

//# sourceMappingURL=main.min.js.map