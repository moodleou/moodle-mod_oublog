define("mod_oublog/savecheck",["exports","core/str","core/notification","core/config","core/pending","core_form/changechecker"],(function(_exports,_str,_notification,_config,_pending,FormChangeChecker){function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _defineProperty(obj,key,value){return key in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_notification=_interopRequireDefault(_notification),_config=_interopRequireDefault(_config),_pending=_interopRequireDefault(_pending),FormChangeChecker=function(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}newObj.default=obj,cache&&cache.set(obj,newObj);return newObj}(FormChangeChecker);class SaveCheck{constructor(contextId){_defineProperty(this,"init",(()=>{const btns=document.querySelectorAll("#id_submitbutton");btns.forEach((btn=>{btn.addEventListener("click",(e=>{this.handleButtonClick(e,btns)}))}))})),_defineProperty(this,"handleButtonClick",((e,btns)=>{e.preventDefault();const pendingPromise=new _pending.default("mod/oublog:savecheck");this.sendCheckRequest((response=>{this.checkSave(response,e,btns),pendingPromise.resolve()}),(error=>{this.checkFailure(error,btns),pendingPromise.resolve()}))})),_defineProperty(this,"saveFail",(async(stringName,info,btns)=>{let content=await(0,_str.getString)("savefailtext","oublog",await(0,_str.getString)(stringName,"oublog"));info&&(content+="[".concat(info,"]")),btns.forEach((btn=>{btn.disabled=!0})),_notification.default.alert(await(0,_str.getString)("savefailtitle","oublog"),content);const cancel=document.querySelector("#id_cancel");cancel&&cancel.addEventListener("click",(()=>{const form=document.querySelector("#region-main .mform");if(form){const text=form.querySelector("#fitem_id_message"),attach=form.querySelector("#fitem_id_attachments");text&&text.remove(),attach&&attach.remove(),form.method="get"}}))})),_defineProperty(this,"checkSave",((response,e,btns)=>{if(-1===response.responseText.search("ok"))this.saveFail("savefailsession",response.responseText,btns);else{const form=e.target.closest("form");form&&(FormChangeChecker.disableAllChecks(),form.submit())}})),_defineProperty(this,"checkFailure",((error,btns)=>{this.saveFail("savefailnetwork",error.statusText,btns)})),_defineProperty(this,"sendCheckRequest",((onSuccess,onFailure)=>{const xhr=new XMLHttpRequest,params="sesskey=".concat(_config.default.sesskey,"&contextid=").concat(this.contextId);xhr.open("POST","confirmloggedin.php",!0),xhr.timeout=3e4,xhr.onreadystatechange=()=>{xhr.readyState===XMLHttpRequest.DONE&&(200===xhr.status?onSuccess(xhr):onFailure(xhr))},xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),xhr.send(params)})),this.contextId=contextId,this.init()}}_exports.init=contextId=>new SaveCheck(contextId)}));

//# sourceMappingURL=savecheck.min.js.map